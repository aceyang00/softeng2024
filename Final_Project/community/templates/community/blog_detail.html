{% extends "base.html" %}

{% block content %}
<div class="post-detail">
    <h1>{{ post.title }}</h1>
    <p class="author">ì‘ì„±ì: {{ post.author }}</p>
    <p class="date">{{ post.created_at|date:"Y-m-d H:i" }}</p>

    {% if post.image %}
    <div class="post-image">
        <img src="{{ post.image.url }}" alt="{{ post.title }}">
    </div>
    {% endif %}

    <div class="post-content">
        <p>{{ post.content }}</p>
    </div>

    <div class="like-comment-actions">
        <button class="like-btn" data-id="{{ post.id }}">
            {% if user in post.likes.all %}
            â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ
            {% else %}
            ğŸ¤ ì¢‹ì•„ìš”
            {% endif %}
        </button>
        <p>ì¢‹ì•„ìš” ìˆ˜: <span id="like-count-{{ post.id }}">{{ post.total_likes }}</span></p>
    </div>

    <div class="comments-section">
        <h2>ëŒ“ê¸€</h2>
        {% if comments %}
        <ul>
            {% for comment in comments %}
            <li>
                <strong>{{ comment.author }}</strong> - {{ comment.created_at|date:"Y-m-d H:i" }}:
                <p>{{ comment.content }}</p>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ì‘ì„±í•´ ë³´ì„¸ìš”!</p>
        {% endif %}

        <form method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">ëŒ“ê¸€ ì‘ì„±</button>
        </form>
    </div>
</div>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const likeButtons = document.querySelectorAll('.like-btn');
        likeButtons.forEach(button => {
            button.addEventListener('click', function () {
                const postId = this.dataset.id;
                fetch(`/community/like/${postId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const likeCount = document.getElementById(`like-count-${postId}`);
                            likeCount.textContent = data.likes;
                            this.innerHTML = data.liked ? 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ' : 'ğŸ¤ ì¢‹ì•„ìš”';
                        }
                    });
            });
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}
